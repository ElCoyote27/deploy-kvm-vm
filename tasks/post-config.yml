---
- name: add host to inventory
  lineinfile:
    path: "{{ inventory_file }}"
    line: "{{ vm_name }}   ansible_host={{ vm_ip.stdout }} ansible_user={{ admin_user }}"
    insertafter: '^\[{{ inventory_group }}\]'
    state: present
  register: update_inventory
  when: update_inventory and vm_ip.stdout is defined

- name: ensure host is added to inventory and its a single entry
  lineinfile:
    path: "{{ inventory_file }}"
    regexp: "^{{ vm_name }}"
    backrefs: yes
    line: "{{ vm_name }}   ansible_host={{ vm_ip.stdout }} ansible_user={{ admin_user }}"
    insertafter: '^\[{{ inventory_group }}\]'
    state: present
  register: ensure_inventory
  when: update_inventory.changed

- name: refresh local static inventory
  meta: refresh_inventory

- name: get vm gateway from DHCP server
  shell: |
       ip route get 8.8.8.8|awk '/via/ {print $3}'
  delegate_to: "{{ vm_name }}"
  when: vm_ip.stdout is defined and vm_ip.stdout != ""
  changed_when: false
  register: vm_gateway

- name: ensure cloud-init is removed
  yum:
    name: cloud-init
    state: absent
  delegate_to: "{{ vm_name }}"
  when: vm_ip.stdout is defined and vm_ip.stdout != ""

- name: Deploy ifcfg-{{ vm_nic.stdout }} to VM
  vars:
    - vm_ipaddress: "{{ vm_ip.stdout }}"
  template:
    src: ifcfg.j2
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ vm_nic.stdout }}"
  delegate_to: "{{ vm_name }}"
  when: vm_ip.stdout is defined and vm_ip.stdout != ""

- name: restart {{ vm_name }} network service
  shell: "(sleep 1; ifdown {{ vm_nic.stdout }} && ifup {{ vm_nic.stdout }} )&"
  become: yes
  args:
    warn: no
  async: 100
  poll: 0
  changed_when: false
  delegate_to: "{{ vm_name }}"

- name: Wait for the hosts network interface to come back up
  wait_for:
    host: "{{ vm_ipaddress }}"
    port: 22
    search_regex: OpenSSH
    delay: 10
  when: vm_ipaddress != ""

- name: update host inventory ip address when user provided ip address
  vars:
    - vm_ipaddress: "{{ vm_ip.stdout }}"
  lineinfile:
    path: "{{ inventory_file }}"
    regexp: "^{{ vm_name }}"
    backrefs: yes
    line: "{{ vm_name }}   ansible_host={{ vm_ipaddress }} ansible_user={{ admin_user }}"
    insertafter: '^\[{{ inventory_group }}\]'
    state: present
  register: ensure_inventory
  when: vm_ipaddress != ""

- name: refresh local static inventory
  meta: refresh_inventory

- name: make sure resolv.conf is has entries
  find:
    paths: /etc/
    contains: '^nameserver ([0-9]{1,3}\.){1,3}[0-9]{1,3}$'
    patterns: "resolv.conf"
  register: resolv_conf_entries
  delegate_to: "{{ vm_name }}"
  become: yes
  when: vm_ip.stdout is defined and vm_ip.stdout != ""

- name: check for dns lookup
  command: getent ahosts www.cnet.com
  failed_when: false
  changed_when: false
  register: dns_lookup_result
  delegate_to: "{{ vm_name }}"
  become: yes
  when: vm_ip.stdout is defined and vm_ip.stdout != ""

- name: update {{ vm_name }} /etc/resolv.conf
  template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
  when: (vm_ip.stdout is defined and vm_ip.stdout != "" and resolv_conf_entries.matched == 0)
        or
        (vm_ip.stdout is defined and vm_ip.stdout != "" and dns_lookup_result.rc == 2)
  delegate_to: "{{ vm_name }}"