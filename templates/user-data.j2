#cloud-config

# Hostname management
preserve_hostname: False
hostname: {{ vm_local_hostname }}
fqdn: {{ vm_hostname }}

# Default Packages
packages:
  - wget
  - git
  - net-tools
  - bind-utils
  - yum-utils
  - iptables-services
  - bridge-utils
  - bash-completion
  - kexec-tools
  - sos
  - psacct
  - ansible
  - pyOpenSSL
  - qemu-guest-agent

# Groups
groups:
  - docker

# Users
users:
  - default
  - name: {{ rhel_user }}
    ssh_pwauth: True
    ssh_authorized_keys:
    - {{ vm_public_key }}
    groups: wheel,adm,systemd-journal
    sudo: ['ALL=(ALL) NOPASSWD:ALL']


# Change password (Reference Only)
ssh_pwauth: True
chpasswd:
  list: |
    {{ rhel_user }}:{{ rhel_user_password }}
  expire: False

# RHEl Subscription Auto-attach
rh_subscription:
  username: {{ rhel_username }}
  password: {{ rhel_password }}
  auto-attach: True
  service-level: self-support

# start qemu-guest-agent
runcmd:
  - [systemctl, start, qemu-guest-agent]

# enable qemu-guest-agent
runcmd:
  - [systemctl, enable, qemu-guest-agent]

# Remove cloud-init when finished with it
runcmd:
  - [ yum, -y, remove, cloud-init ]

# Configure where output will go
output:
  all: ">> /var/log/cloud-init.log"

# configure interaction with ssh server
ssh_svcname: ssh
ssh_deletekeys: True
ssh_genkeytypes: ['rsa', 'ecdsa']

# Install my public ssh key to the first user-defined user configured
# in cloud.cfg in the template (which is ctos for CentOS cloud images)
ssh_authorized_keys:
  - {{ vm_public_key }}
